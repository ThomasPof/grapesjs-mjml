<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>ðŸ’Œ Email builder</title>
  <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
  <script src="https://unpkg.com/grapesjs"></script>
  <script src="dist/grapesjs-mjml.min.js"></script>
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
    }

    .cke_top {
      background: #444 !important;
    }

    .cke_chrome {
      border: none !important;
    }

    .cke_toolgroup {
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
    }
    .gjs-mdl-container-small .gjs-mdl-dialog {
      max-width: 300px;
    }

    /* .gjs-dashed *[data-highlightable] {
      padding: 10px 0px !important
    } */
  </style>
</head>

<body>

  <div id="gjs" style="height:0px; overflow:hidden">
    <mjml>
      <mj-head>
        <mj-font name="Barlow" href="https://fonts.googleapis.com/css?family=Barlow" />

        <mj-style>
          .slogan {
            background: #000;
          }
        </mj-style>
      </mj-head>
      <mj-body>
        <!-- Company Header -->
        <mj-section background-color="#f0f0f0">
          <mj-column>
            <mj-text font-family="Barlow">A first line of text</mj-text>
            <mj-spacer height="50px" />
          </mj-column>
        </mj-section>

        <!-- Image Header -->
        <mj-section background-url="http://1.bp.blogspot.com/-TPrfhxbYpDY/Uh3Refzk02I/AAAAAAAALw8/5sUJ0UUGYuw/s1600/New+York+in+The+1960's+-+70's+(2).jpg"
          background-size="cover" background-repeat="no-repeat">
          <mj-column>
            <mj-text css-class="slogan" align="center" color="#fff" font-size="40px" font-family="Helvetica Neue">Slogan here</mj-text>
            <mj-button background-color="#F63A4D" href="#">
              Promotion
            </mj-button>
          </mj-column>
        </mj-section>

        <!-- Intro text -->
        <mj-wrapper background-color="#ffe9f7" padding="10px">
          <mj-section background-color="#eaeffa">
            <mj-group background-color="#fffadd">
              <mj-column>
                <mj-text font-style="italic" font-size="20px" font-family="Helvetica Neue" color="#626262">My Awesome Text</mj-text>
                <mj-text color="#525252">
                  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin rutrum enim eget magna efficitur, eu semper augue semper.
                  Aliquam erat volutpat. Cras id dui lectus. Vestibulum sed finibus lectus, sit amet suscipit nibh. Proin nec
                  commodo purus. Sed eget nulla elit. Nulla aliquet mollis faucibus.
                </mj-text>
                <mj-button background-color="#F45E43" href="#">Learn more</mj-button>
              </mj-column>
            </mj-group>
          </mj-section>
        </mj-wrapper>

        <!-- Side image -->
        <mj-section background-color="white">
          <mj-column>
            <mj-image width="200px" src="https://designspell.files.wordpress.com/2012/01/sciolino-paris-bw.jpg" />
          </mj-column>
          <mj-column>
            <mj-text font-style="italic" font-size="20px" font-family="Helvetica Neue" color="#626262">
              Find amazing places ...
            </mj-text>
            <mj-text color="#525252">
              Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin rutrum enim eget magna efficitur, eu semper augue semper.
              Aliquam erat volutpat. Cras id dui lectus. Vestibulum sed finibus lectus.</mj-text>
          </mj-column>
        </mj-section>
        <mj-section>
          <mj-column>
            <mj-text font-style="italic" font-size="20px" font-family="Helvetica Neue" color="#626262" align="center">
              ... with real-life images
            </mj-text>
          </mj-column>
        </mj-section>
        <mj-raw>
          <div class="container">
            <img class="item" src="https://source.unsplash.com/random/200x141" alt="Example image">
            <img class="item" src="https://source.unsplash.com/random/200x142" alt="Example image">
            <img class="item" src="https://source.unsplash.com/random/200x143" alt="Example image">
            <img class="item" src="https://source.unsplash.com/random/200x144" alt="Example image">
            <img class="item" src="https://source.unsplash.com/random/200x145" alt="Example image">
            <img class="item" src="https://source.unsplash.com/random/200x146" alt="Example image">
          </div>
        </mj-raw>
        <!-- Icons -->
        <mj-section background-color="#fbfbfb">
          <mj-column>
            <mj-image width="100px" src="http://191n.mj.am/img/191n/3s/x0l.png" />
          </mj-column>
          <mj-column>
            <mj-image width="100px" src="http://191n.mj.am/img/191n/3s/x01.png" />
          </mj-column>
          <mj-column>
            <mj-image width="100px" src="http://191n.mj.am/img/191n/3s/x0s.png" />
          </mj-column>
        </mj-section>

        <!-- Footer -->
        <mj-section background-color="#e7e7e7">
          <mj-column>
            <mj-button href="#">Hello There!</mj-button>
            <mj-social font-size="15px" icon-size="30px" mode="horizontal">
              <mj-social-element name="facebook" href="https://mjml.io/">
                Facebook
              </mj-social-element>
              <mj-social-element name="google" href="https://mjml.io/">
                Google
              </mj-social-element>
              <mj-social-element name="twitter" href="https://mjml.io/">
                Twitter
              </mj-social-element>
            </mj-social>
          </mj-column>
        </mj-section>
        <!-- Footer -->
      </mj-body>
    </mjml>
  </div>


  <script type="text/javascript">
    var editor = grapesjs.init({
      height: '100%',
      noticeOnUnload: 0,
      storageManager: { autoload: 1, autosave: true},
      container: '#gjs',
      fromElement: true,
      plugins: ['grapesjs-mjml'],
      pluginsOpts: {
        'grapesjs-mjml': {}
      },
      assetManager: {
        storageType: '',
        storeOnChange: true,
        storeAfterUpload: true,
        // upload: '/assets/upload', //for temporary storage
        assets: [],
        uploadFile: function (e) {
          var files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
          var formData = new FormData();
          for (var i in files) {
            formData.append('file-' + i, files[i])
          }
          var httpRequest = new XMLHttpRequest();
          httpRequest.open("POST", "/upload_image.php",true);
          httpRequest.send(formData);
          httpRequest.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              var result = JSON.parse(this.responseText)
              editor.AssetManager.add(result['data']);

            }
          };
        },
      },
    });

    // READ IMAGES IN /uploads/ FOLDER and write it in gjs-assets
    const am = editor.AssetManager;
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "read_uploads.php", true);
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        console.log(this.responseText)
        var result = JSON.parse(this.responseText)
        var assets = []
        result.forEach(image => {
          let asset = {}
          Object.keys(image).forEach(function (key) {
            asset[key] = image[key]
          });
          console.log(image);
          assets.push(asset)
        });
        // localStorage.setItem('gjs-assets',JSON.stringify(assets))
        am.add(assets)
      }
    };
    xhttp.send()

    // ADD SAVE/LOAD BUTTONS
    var pnm = editor.Panels;
    pnm.addButton('options', [
      { id: 'save-database',
        className: 'fa fa-floppy-o',
        command: 'save-database',
        attributes: {title: 'Save to database'}
      },
      { id: 'load-from-database',
        className: 'fa fa-cloud-download',
        command: 'load-from-database',
        attributes: {title: 'Load from database'}
      }
    ])

    // CREATE MODAL CONTENT BEFORE LOAD
    const container = document.createElement('div');
    const btnSave = document.createElement('button');
    const btnImport = document.createElement('button');
    const config = editor.getConfig();
    const pfx = config.stylePrefix || '';
    const input = document.createElement('input');
    const select = document.createElement('select');
    const inputContainer = document.createElement('div');
    inputContainer.classList = "gjs-field";
    input.type = "text";
    input.setAttribute('name', 'template-name');
    input.setAttribute('placeholder','Nom du template...');

    select.setAttribute('name', 'template-names');

    btnSave.innerHTML = 'Enregistrer le template';
    btnImport.innerHTML = 'Importer ce template';
    btnSave.className = `${pfx}btn-prim ${pfx}btn-import`;
    btnImport.className = `${pfx}btn-prim ${pfx}btn-import`;
    btnSave.onclick = () => {
      let html = encodeURIComponent(editor.getHtml())
      let name = encodeURIComponent(document.querySelector('[name=template-name]').value)

      let params = "name="+name + "&html="+html;
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", "save.php", true);
      xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          editor.Modal.close();
        }
      };
      xhttp.send(params);
    };

    btnImport.onclick = () => {
      let name = document.querySelector('[name=template-names]').value;
      let params = "template_name="+name;

      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", "load.php", true);
      xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          editor.DomComponents.getWrapper().set('content', '');
          editor.setComponents(this.responseText);
          input.value = name;
          editor.Modal.close();
          editor.runCommand('mjml-import:change');
        }
      };
      xhttp.send(params);
    };

    // ADD FUNCTIONS TO BUTTONS
    const cmdm = editor.Commands;
    const modal = editor.Modal;
    cmdm.add('save-database', {
      run: function (em, sender) {
        modal.setTitle('Sauvegarder le template');
        container.innerHTML = '';
        inputContainer.innerHTML = '';
        inputContainer.appendChild(input);
        container.appendChild(inputContainer);
        container.appendChild(btnSave);
        modal.setContent(container);
        modal.open({
          attributes: {
            'class': "gjs-mdl-container-small",
          }
        });
      },
    }).add('load-from-database', {
      run: function(em, sender) {
        select.innerHTML = "";
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "load.php", true);
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            let template_names = JSON.parse(this.responseText);
            template_names.forEach(element => {
              let option = document.createElement('option');
              option.value = element;
              option.innerHTML = element;
              select.appendChild(option)
            });
          }
        };
        xhttp.send();

        modal.setTitle('Importer un template');
        container.innerHTML = '';
        inputContainer.innerHTML = '';
        inputContainer.appendChild(select);
        container.appendChild(inputContainer);
        container.appendChild(btnImport);
        modal.setContent(container);
        modal.open({
          attributes: {
            'class': "gjs-mdl-container-small",
          }
        });
      }
    })



    window.editor = editor;
  </script>
</body>

</html>
